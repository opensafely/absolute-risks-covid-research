-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /workspace/logs/AL011_cox_regression_wave2_covidadmission_MI.log
  log type:  text
 opened on:  23 Apr 2021, 11:58:42

. 
. 
. * Categories of various exposures
. local lo_ldr            = 0

. local hi_ldr            = 1

. local lo_ldr_cat        = 0

. local hi_ldr_cat        = 2

. local hi_ldr            = 1

. local lo_ldr_carecat= 0

. local hi_ldr_carecat= 2

. local lo_ds             = 0

. local hi_ds             = 1

. local lo_cp             = 0

. local hi_cp             = 1

. local lo_ldr_group      = 0

. local hi_ldr_group      = 5

. 
. * Open temporary file to post results
. tempfile ldrfile

. tempname ldrresults

. 
. postfile `ldrresults'   wave str15(outcome) str15(exposure) str20(model)     
>    ///
>                                                 expcat lnhr sehr using `ldrfi
> le'

. 
. 
.         * Open dataset (complete case ethnicity)
.         use "analysis/data_ldanalysis_cohort`i'.dta", clear 
(Analysis dataset, wave 2 (1 Sept 20 - 3 March 21), for learning disability wor
> k)

.         
. */      
. 
.         
. local i= 1

. local out = "coviddeath"

. local exp = "ldr"

.         
.         
.         use "analysis/data_ldanalysis_cohort1.dta", clear
(Analysis dataset, wave 1 (1 Mar - 31 Aug 20), for learning disability work)

. 
.         * Only keep data for adults
.         keep if child==0
(9,597 observations deleted)

. 
.         /*  Declare data to be survival  */
.         
.         stset stime_`out'`i', fail(`out'`i') scale(365.25)

     failure event:  coviddeath1 != 0 & coviddeath1 < .
obs. time interval:  (0, stime_coviddeath1]
 exit on or before:  failure
    t for analysis:  time/365.25

------------------------------------------------------------------------------
     40,397  total observations
          0  exclusions
------------------------------------------------------------------------------
     40,397  observations remaining, representing
        751  failures in single-record/single-failure data
 19,461.046  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  .5037645

.                 
.                 
.         /*  Obtain rates  */
.                 
.         strate ldr,                                                          
>                            ///
>                         output(output/data_temp`i'_`out'_mi, replace)   ///
>                         per(10000)

         failure _d:  coviddeath1
   analysis time _t:  stime_coviddeath1/365.25

Estimated rates (per 10000) and lower/upper bounds of 95% confidence intervals
(40397 records included in the analysis)

  +-----------------------------------------------+
  | ldr     D        Y     Rate    Lower    Upper |
  |-----------------------------------------------|
  |   0   370   0.9557   387.14   349.64   428.67 |
  |   1   381   0.9904   384.70   347.95   425.34 |
  +-----------------------------------------------+


.                         
.         
.         
.         
.         use "analysis/data_ldanalysis_cohort1_MI.dta", clear
(Analysis dataset, wave 1 (1 Mar - 31 Aug 20), for learning disability work)

. 
.         * Only keep data for adults
.         keep if child==0
(9,597 observations deleted)

.         
. 
.         /*  Declare data to be survival  */
.         
.         mi stset stime_`out'`i', fail(`out'`i') scale(365.25)

     failure event:  coviddeath1 != 0 & coviddeath1 < .
obs. time interval:  (0, stime_coviddeath1]
 exit on or before:  failure
    t for analysis:  time/365.25

------------------------------------------------------------------------------
     40,397  total observations
          0  exclusions
------------------------------------------------------------------------------
     40,397  observations remaining, representing
        751  failures in single-record/single-failure data
 19,461.046  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  .5037645

.         
. 
.         /*  Fit Cox models  */
. 
.         
.         * Confounder only model
.         mi estimate, eform post:                                             
>                            ///
>         stcox i.`exp' age1 age2 age3 male i.ethnicity_5_adult,          ///
>                 strata(stpcode) cluster(household_id) 

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =     40,397
                                                Average RVI       =     0.1835
                                                Largest FMI       =     0.5224
DF adjustment:   Large sample                   DF:     min       =      36.46
                                                        avg       =   1.64e+09
                                                        max       =   4.90e+09
Model F test:       Equal FMI                   F(   9, 3073.9)   =       0.55
Within VCE type:       Robust                   Prob > F          =     0.8379

                      (Within VCE adjusted for 1,266 clusters in household_id)
------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       1.ldr |   .9888789   .0732848    -0.15   0.880     .8551877     1.14347
        age1 |   .9864016   .0225976    -0.60   0.550     .9430907    1.031702
        age2 |   1.048856    .056203     0.89   0.373     .9442871    1.165004
        age3 |   .8739691    .114337    -1.03   0.303     .6762973    1.129417
        male |   1.001508   .0745244     0.02   0.984     .8655949    1.158762
             |
ethnicity_~t |
          2  |   .8727437   .1126397    -1.05   0.293      .676841    1.125348
          3  |    .879854   .1132371    -0.99   0.321     .6823539    1.134519
          4  |   .8734898   .1148679    -1.03   0.306     .6731808    1.133402
          5  |   .8588809   .1400583    -0.93   0.357     .6171123    1.195368
------------------------------------------------------------------------------

.         forvalues k = `lo_`exp'' (1) `hi_`exp'' {
  2.                 capture qui di _b[`k'.`exp']
  3.                 if _rc==0 {
  4.                         post `ldrresults' (`i') ("`out'") ("`exp'")       
>       ///
>                                 ("Confounders")                              
>                            ///
>                                 (`k') (_b[`k'.`exp']) (_se[`k'.`exp'])
  5.                 }
  6.         }

.         
.         * Confounders with deprivation
.         mi estimate, eform post:                                             
>                                    ///
>         stcox i.`exp' age1 age2 age3 male i.ethnicity_5_adult i.imd,    ///
>                 strata(stpcode) cluster(household_id) 

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =     40,397
                                                Average RVI       =     0.1506
                                                Largest FMI       =     0.5217
DF adjustment:   Large sample                   DF:     min       =      36.55
                                                        avg       =   4.90e+09
                                                        max       =   2.63e+10
Model F test:       Equal FMI                   F(  11, 5358.5)   =       0.57
Within VCE type:       Robust                   Prob > F          =     0.8509

                      (Within VCE adjusted for 1,266 clusters in household_id)
------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       1.ldr |   .9881677    .073177    -0.16   0.872     .8546661    1.142523
        age1 |    .986248   .0226081    -0.60   0.546     .9429176     1.03157
        age2 |   1.049189    .056252     0.90   0.370     .9445318    1.165442
        age3 |   .8734154   .1143206    -1.03   0.301     .6757839    1.128844
        male |   1.001402   .0745678     0.02   0.985     .8654167    1.158756
             |
ethnicity_~t |
          2  |   .8726284   .1125538    -1.06   0.292     .6768671    1.125007
          3  |   .8800921   .1131919    -0.99   0.322     .6826719    1.134604
          4  |   .8727031   .1146981    -1.04   0.302     .6726884    1.132189
          5  |   .8585727   .1399614    -0.94   0.356     .6169772    1.194772
             |
         imd |
          2  |   1.008862   .1036499     0.09   0.932     .8248588     1.23391
          4  |   1.100646   .1102079     0.96   0.338     .9045168    1.339302
------------------------------------------------------------------------------

.         forvalues k = `lo_`exp'' (1) `hi_`exp'' {
  2.                 capture qui di _b[`k'.`exp']
  3.                 if _rc==0 {
  4.                         post `ldrresults' (`i') ("`out'") ("`exp'")     //
> /
>                                 ("Confounders+IMD")                          
>                    ///
>                                 (`k') (_b[`k'.`exp']) (_se[`k'.`exp'])
  5.                 }               
  6.         }

.         
.         * Confounders with residential care
.         *       (don't do for exposure split by residential care)
.         if "`exp'"=="ldr_carecat" {
.                 forvalues k = `lo_`exp'' (1) `hi_`exp'' {
  2.                         post `ldrresults' (`i') ("`out'") ("`exp'")     //
> /
>                                 ("Confounders+Resid") (`k') (.) (.)
  3.                 }
.         } 

.         else {
.                 mi estimate, eform post:                                     
>                            ///
>                 stcox i.`exp' age1 age2 age3 male i.ethnicity_5_adult   ///
>                         resid_care_ldr,                                      
>                                    ///
>                         strata(stpcode) cluster(household_id) 

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =     40,397
                                                Average RVI       =     0.1653
                                                Largest FMI       =     0.5224
DF adjustment:   Large sample                   DF:     min       =      36.45
                                                        avg       =   1.77e+09
                                                        max       =   4.99e+09
Model F test:       Equal FMI                   F(  10, 4116.1)   =       0.50
Within VCE type:       Robust                   Prob > F          =     0.8887

                      (Within VCE adjusted for 1,266 clusters in household_id)
------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       1.ldr |   .9886618   .0732691    -0.15   0.878     .8549993     1.14322
        age1 |   .9863839   .0225973    -0.60   0.550     .9430736    1.031683
        age2 |   1.048891   .0562091     0.89   0.373     .9443116    1.165053
        age3 |   .8739008   .1143381    -1.03   0.303     .6762292    1.129355
        male |   1.001395   .0744614     0.02   0.985     .8655899    1.158508
             |
ethnicity_~t |
          2  |   .8726412   .1126242    -1.06   0.292     .6767655    1.125209
          3  |   .8797458   .1132273    -1.00   0.321     .6822638    1.134389
          4  |   .8734212   .1148805    -1.03   0.306      .673096    1.133367
          5  |   .8587555   .1400165    -0.93   0.356      .617053    1.195134
             |
resid_care~r |   1.026071   .2002641     0.13   0.895     .6999124     1.50422
------------------------------------------------------------------------------
.                 forvalues k = `lo_`exp'' (1) `hi_`exp'' {
  2.                         capture qui di _b[`k'.`exp']
  3.                         if _rc==0 {
  4.                                 post `ldrresults' (`i') ("`out'") ("`exp'"
> )     ///
>                                         ("Confounders+Resid")                
>                            ///
>                                         (`k') (_b[`k'.`exp']) (_se[`k'.`exp']
> )
  5.                         }               
  6.                 }
.         }

.         
.         * Confounders with physical comorbidities that are indicators for vac
> cination 
.         mi estimate, eform post:                                             
>                    ///
>         stcox i.`exp' age1 age2 age3 male i.ethnicity_5_adult   ///
>                                 obese40                                      
>                                    ///
>                                 respiratory asthma_severe                    
>                    ///
>                                 cardiac af dvt_pe i.diabcat                  
>                    ///
>                                 liver stroke tia dementia                    
>                    ///
>                                 i.kidneyfn                                   
>                                    ///
>                                 spleen transplant dialysis                   
>                    ///
>                                 immunosuppression i.cancerHaem               
>            ///
>                                 autoimmune ibd cancerExhaem1yr,              
>            ///
>                 strata(stpcode) cluster(household_id) 

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =     40,397
                                                Average RVI       =          .
                                                Largest FMI       =          .
DF adjustment:   Large sample                   DF:     min       =       0.00
                                                        avg       =          .
                                                        max       =          .
Model F test:       Equal FMI                   F(  33,114732.4)  =       0.89
Within VCE type:       Robust                   Prob > F          =     0.6437

                      (Within VCE adjusted for 1,266 clusters in household_id)
------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       1.ldr |   .9861241    .073043    -0.19   0.850     .8528692    1.140199
        age1 |   .9872219   .0226792    -0.56   0.576     .9437573    1.032688
        age2 |   1.046938   .0562609     0.85   0.393     .9422772    1.163224
        age3 |   .8778958   .1151628    -0.99   0.321     .6788628    1.135283
        male |   1.000295   .0751536     0.00   0.997     .8633285    1.158991
             |
ethnicity_~t |
          2  |    .873978   .1124326    -1.05   0.296       .67838    1.125973
          3  |   .8818624   .1135545    -0.98   0.330     .6837806    1.137326
          4  |   .8760189   .1154602    -1.00   0.317     .6746759    1.137449
          5  |   .8604465   .1401489    -0.92   0.362     .6185015    1.197035
             |
     obese40 |   1.018085   .0899962     0.20   0.839     .8561306    1.210677
 respiratory |   .9835037   .0907765    -0.18   0.857       .82075    1.178531
asthma_sev~e |    .830577   .2469521    -0.62   0.532     .4637624    1.487525
     cardiac |    1.17549   .1049452     1.81   0.070     .9867921    1.400272
          af |   .9487794   .0927098    -0.54   0.591     .7834121    1.149053
      dvt_pe |    1.15106   .1002624     1.62   0.106     .9704081    1.365341
             |
     diabcat |
Controlle..  |   .9939734   .1055836    -0.06   0.955     .8071549    1.224032
Uncontrol..  |   1.295933   .2199374     1.53   0.127     .9292272    1.807353
Diabetes,..  |   8.02e-16          .        .       .            .           .
             |
       liver |   .9957731   .0940837    -0.04   0.964     .8274395    1.198352
      stroke |    1.00171   .0939819     0.02   0.985     .8334531    1.203935
         tia |   1.032345   .0911872     0.36   0.719      .868237    1.227473
    dementia |    .998423   .0854597    -0.02   0.985     .8442211    1.180791
             |
    kidneyfn |
Stage 3a/..  |     .94551   .4245801    -0.12   0.901     .3921346    2.279802
Stage 4/5..  |   .8545466   .1026305    -1.31   0.191      .675316    1.081345
             |
      spleen |   .9216019   .0689432    -1.09   0.275      .795915    1.067137
  transplant |   1.133796   .1021191     1.39   0.163     .9503173    1.352699
    dialysis |   1.126315   .1487097     0.90   0.368     .8695089    1.458968
immunosupp~n |   1.160204   .0857052     2.01   0.044     1.003819    1.340952
             |
  cancerHaem |
  Last year  |   1.582662   .7141204     1.02   0.309     .6536022     3.83233
2-5 years..  |   .6758422   .2690051    -0.98   0.325     .3097719    1.474513
   5+ years  |   .8614521    .083871    -1.53   0.126     .7118003    1.042567
             |
  autoimmune |   1.012795   .0894558     0.14   0.886     .8518022    1.204216
         ibd |   1.140954   .1012628     1.49   0.137     .9587859    1.357734
cancerExha~r |   .9957238   .5203244    -0.01   0.993     .3575493    2.772949
------------------------------------------------------------------------------

.         forvalues k = `lo_`exp'' (1) `hi_`exp'' {
  2.                 capture qui di _b[`k'.`exp']
  3.                 if _rc==0 {
  4.                         post `ldrresults' (`i') ("`out'") ("`exp'")     //
> /
>                         ("Confounders+Comorb")                               
>                    ///
>                         (`k') (_b[`k'.`exp']) (_se[`k'.`exp'])
  5.                 }
  6.         }

.         
.         * All variables
.         if "`exp'"=="ldr_carecat" {
.                 local rc = " "
.         }

.         else {
.                 local rc = "resid_care_ldr"
.         }

.         
.         mi estimate, eform post:                                             
>                    ///
>         stcox i.`exp' age1 age2 age3 male i.ethnicity_5_adult   ///
>                                 i.imd `rc'                                   
>                                    ///
>                                 obese40                                      
>                                    ///
>                                 respiratory asthma_severe                    
>                    ///
>                                 cardiac af dvt_pe i.diabcat                  
>                    ///
>                                 liver stroke tia dementia                    
>                    ///
>                                 i.kidneyfn                                   
>                                    ///
>                                 spleen transplant dialysis                   
>                    ///
>                                 immunosuppression i.cancerHaem               
>            ///
>                                 autoimmune ibd cancerExhaem1yr,              
>            ///
>                 strata(stpcode) cluster(household_id) 

Multiple-imputation estimates                   Imputations       =         10
Stratified Cox regr.: Breslow method for ties   Number of obs     =     40,397
                                                Average RVI       =     7.8805
                                                Largest FMI       =     0.9969
DF adjustment:   Large sample                   DF:     min       =       9.07
                                                        avg       =   4.27e+09
                                                        max       =   3.13e+10
Model F test:       Equal FMI                   F(  37,  421.2)   =     120.95
Within VCE type:       Robust                   Prob > F          =     0.0000

                      (Within VCE adjusted for 1,266 clusters in household_id)
------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       1.ldr |   .9850901    .072912    -0.20   0.839     .8520671     1.13888
        age1 |   .9870314   .0226922    -0.57   0.570     .9435428    1.032525
        age2 |    1.04737   .0563268     0.86   0.389     .9425912    1.163797
        age3 |   .8771191   .1151414    -1.00   0.318     .6781401    1.134482
        male |   .9999639   .0751327    -0.00   1.000     .8630362    1.158616
             |
ethnicity_~t |
          2  |   .8737444   .1123314    -1.05   0.295     .6783151    1.125479
          3  |   .8818861   .1135153    -0.98   0.330      .683877    1.137227
          4  |   .8751927   .1153095    -1.01   0.314     .6741177    1.136244
          5  |   .8599504     .13999    -0.93   0.360     .6182753    1.196093
             |
         imd |
          2  |   1.008938   .1035246     0.09   0.931     .8251347    1.233685
          4  |   1.099176   .1100203     0.94   0.345      .903374    1.337417
             |
resid_care~r |   1.027129   .2008539     0.14   0.891     .7001215    1.506872
     obese40 |   1.018171   .0899696     0.20   0.839     .8562586    1.210699
 respiratory |   .9840008   .0908183    -0.17   0.861     .8211715    1.179117
asthma_sev~e |   .8308289   .2471411    -0.62   0.533     .4637783    1.488376
     cardiac |   1.175489   .1048441     1.81   0.070     .9869569    1.400035
          af |   .9489752   .0926367    -0.54   0.592      .783723    1.149072
      dvt_pe |   1.150432   .1002109     1.61   0.108     .9698739    1.364605
             |
     diabcat |
Controlle..  |   .9936681    .105539    -0.06   0.952     .8069263    1.223626
Uncontrol..  |    1.29521   .2198245     1.52   0.127     .9286958    1.806372
Diabetes,..  |   1.44e-14   3.92e-14   -11.69   0.000     3.04e-17    6.79e-12
             |
       liver |   .9958975   .0941346    -0.04   0.965     .8274791    1.198594
      stroke |   1.002369   .0940166     0.03   0.980      .834045    1.204663
         tia |    1.03225   .0912373     0.36   0.720     .8680602    1.227496
    dementia |   .9971484   .0852995    -0.03   0.973     .8432281    1.179165
             |
    kidneyfn |
Stage 3a/..  |   .9428587   .4231825    -0.13   0.896     .3912033    2.272431
Stage 4/5..  |   .8554321   .1027051    -1.30   0.193     .6760649    1.082387
             |
      spleen |   .9219917   .0689405    -1.09   0.277     .7963055    1.067516
  transplant |   1.133409   .1021365     1.39   0.165     .9499073     1.35236
    dialysis |   1.125549   .1485584     0.90   0.370     .8689934    1.457848
immunosupp~n |   1.160351   .0856904     2.01   0.044      1.00399    1.341064
             |
  cancerHaem |
  Last year  |   1.585413   .7159454     1.02   0.307     .6542659    3.841762
2-5 years..  |   .6769625    .269444    -0.98   0.327     .3102917    1.476927
   5+ years  |   .8613671   .0838486    -1.53   0.125     .7117528    1.042431
             |
  autoimmune |   1.012731   .0894467     0.14   0.886     .8517537    1.204132
         ibd |   1.140412   .1012037     1.48   0.139     .9583489    1.357063
cancerExha~r |   1.000351   .5225713     0.00   0.999     .3593311    2.784901
------------------------------------------------------------------------------

.         forvalues k = `lo_`exp'' (1) `hi_`exp'' {
  2.                 capture qui di _b[`k'.`exp']
  3.                 if _rc==0 {
  4.                         post `ldrresults' (`i') ("`out'") ("`exp'")     //
> /
>                         ("All")                                              
>                                    ///
>                         (`k') (_b[`k'.`exp']) (_se[`k'.`exp'])
  5.                 }
  6.         }

.         
. 
. postclose `ldrresults'

. 
. use `ldrfile', clear

. 
. 
. *************************
. *  Tidy output for HRs  *
. *************************
. 
. * Outcome
. rename outcome out

. gen outcome     = 1 if out=="coviddeath"

. replace outcome = 2 if out=="covidadmission"
(0 real changes made)

. replace outcome = 3 if out=="composite"
(0 real changes made)

. 
. label define outcome    1 "COVID-19 death"              ///
>                                                 2 "COVID-19 admission"  ///
>                                                 3 "Composite"

. label values outcome outcome

. drop out

. 
. * Exposure
. rename exposure exp

. gen     exposure = 1 if exp=="ldr"

. replace exposure = 2 if exp=="ldr_cat"
(0 real changes made)

. replace exposure = 3 if exp=="ldr_carecat"
(0 real changes made)

. replace exposure = 4 if exp=="ds"
(0 real changes made)

. replace exposure = 5 if exp=="cp"
(0 real changes made)

. replace exposure = 6 if exp=="ldr_group"
(0 real changes made)

. 
. label define exposure   1 "Learning disability register"        ///
>                                                 2 "LDR Severe vs mild"       
>                    ///
>                                                 3 "LDR by residential care"  
>                    ///
>                                                 4 "Down's syndrome"          
>                            ///
>                                                 5 "Cerebral Palsy"           
>                            ///
>                                                 6 "Combined grouping"        
>                    

. label values exposure exposure                                          

. drop exp

. 
. * Categories of exposure
. gen category     = "No"                                         if expcat==0
(5 missing values generated)

. replace category = "Yes"                                        if inlist(exp
> osure, 1, 4, 5) & expcat==1
variable category was str2 now str3
(5 real changes made)

. 
. replace category = "LDR, mild"                          if inlist(exposure, 2
> ) & expcat==1
(0 real changes made)

. replace category = "LDR, profound"                      if inlist(exposure, 2
> ) & expcat==2
(0 real changes made)

. 
. replace category = "LDR, community"             if inlist(exposure, 3) & expc
> at==1
(0 real changes made)

. replace category = "LDR, residential care"      if inlist(exposure, 3) & expc
> at==2
(0 real changes made)

. 
. replace category = "DS but not LDR"             if inlist(exposure, 6) & expc
> at==1
(0 real changes made)

. replace category = "DS and LDR"                         if inlist(exposure, 6
> ) & expcat==2
(0 real changes made)

. replace category = "CP but not LDR"             if inlist(exposure, 6) & expc
> at==3
(0 real changes made)

. replace category = "CP and LDR"                         if inlist(exposure, 6
> ) & expcat==4
(0 real changes made)

. replace category = "LDR with no DS or CP"       if inlist(exposure, 6) & expc
> at==5
(0 real changes made)

. 
. * Model adjustment
. gen     adjustment = 1 if model=="Confounders"
(8 missing values generated)

. replace adjustment = 2 if model=="Confounders+IMD"
(2 real changes made)

. replace adjustment = 3 if model=="Confounders+Resid"
(2 real changes made)

. replace adjustment = 4 if model=="Confounders+Comorb"
(2 real changes made)

. replace adjustment = 5 if model=="All"
(2 real changes made)

. label define adj        1 "Confounders"                                      
>    ///     
>                                         2 "Confounders with IMD"             
>            ///
>                                         3 "Confounders with care"            
>            ///
>                                         4 "Confounders with comorbidities"   
>    ///
>                                         5 "All" 

. label values adjustment adj

. drop model

. 
. * Hazard ratio with 95% confidence interval
. gen cl = exp(lnhr - invnorm(0.975)*sehr)

. gen cu = exp(lnhr + invnorm(0.975)*sehr)

. gen hr = exp(lnhr)

. 
. gen hr_ci =   string(round(hr, 0.01)) + " (" ///
>                         + string(round(cl, 0.01)) + ", " ///
>                         + string(round(cu, 0.01)) + ")"

. replace hr_ci = "" if expcat==0
(5 real changes made)

. drop cl cu hr lnhr sehr

. 
. * Put in wide format
. reshape wide hr_ci, i(wave outcome exposure expcat) j(adjust)
(note: j = 1 2 3 4 5)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                       10   ->       2
Number of variables                   7   ->      10
j variable (5 values)        adjustment   ->   (dropped)
xij variables:
                                  hr_ci   ->   hr_ci1 hr_ci2 ... hr_ci5
-----------------------------------------------------------------------------

. rename hr_ci1 hr_conf

. rename hr_ci2 hr_conf_imd

. rename hr_ci3 hr_conf_resid

. rename hr_ci4 hr_conf_comorb

. rename hr_ci5 hr_all

. 
. 
. order wave outcome exposure category hr*

. sort wave outcome exposure expcat

. 
. * Save data
. save "output/ldhrs_wave`i'_`out'_mi", replace
(note: file output/ldhrs_wave1_coviddeath_mi.dta not found)
file output/ldhrs_wave1_coviddeath_mi.dta saved

. 
. 
. 
. ***************************
. *  Tidy output for rates  *
. ***************************
. 
. 
. use "output/data_temp`i'_`out'_mi", clear
(Analysis dataset, wave 1 (1 Mar - 31 Aug 20), for learning disability work)

. gen wave = `i'

. gen exp = "`exp'"

. gen out = "`out'"

. erase "output/data_temp`i'_`out'_mi.dta"

. 
. 
. * Outcome
. gen outcome     = 1 if out=="coviddeath"

. replace outcome = 2 if out=="covidadmission"
(0 real changes made)

. replace outcome = 3 if out=="composite"
(0 real changes made)

. 
. label define outcome    1 "COVID-19 death"              ///
>                                                 2 "COVID-19 admission"  ///
>                                                 3 "Composite"

. label values outcome outcome

. drop out

. 
. * Exposure
. gen     exposure = 1 if exp=="ldr"

. replace exposure = 2 if exp=="ldr_cat"
(0 real changes made)

. replace exposure = 3 if exp=="ldr_carecat"
(0 real changes made)

. replace exposure = 4 if exp=="ds"
(0 real changes made)

. replace exposure = 5 if exp=="cp"
(0 real changes made)

. replace exposure = 6 if exp=="ldr_group"
(0 real changes made)

. 
. label define exposure   1 "Learning disability register"        ///
>                                                 2 "LDR Severe vs mild"       
>                    ///
>                                                 3 "LDR by residential care"  
>                    ///
>                                                 4 "Down's syndrome"          
>                            ///
>                                                 5 "Cerebral Palsy"           
>                            ///
>                                                 6 "Combined grouping"        
>                    

. label values exposure exposure                                          

. drop exp

. 
. * Categories of exposure
. rename `exp' expcat

. gen category     = "No"                                         if expcat==0
(1 missing value generated)

. replace category = "Yes"                                        if inlist(exp
> osure, 1, 4, 5) & expcat==1
variable category was str2 now str3
(1 real change made)

. 
. replace category = "LDR, mild"                          if inlist(exposure, 2
> ) & expcat==1
(0 real changes made)

. replace category = "LDR, profound"                      if inlist(exposure, 2
> ) & expcat==2
(0 real changes made)

. 
. replace category = "LDR, community"             if inlist(exposure, 3) & expc
> at==1
(0 real changes made)

. replace category = "LDR, residential care"      if inlist(exposure, 3) & expc
> at==2
(0 real changes made)

. 
. replace category = "DS but not LDR"             if inlist(exposure, 6) & expc
> at==1
(0 real changes made)

. replace category = "DS and LDR"                         if inlist(exposure, 6
> ) & expcat==2
(0 real changes made)

. replace category = "CP but not LDR"             if inlist(exposure, 6) & expc
> at==3
(0 real changes made)

. replace category = "CP and LDR"                         if inlist(exposure, 6
> ) & expcat==4
(0 real changes made)

. replace category = "LDR with no DS or CP"       if inlist(exposure, 6) & expc
> at==5
(0 real changes made)

. 
. * Rename remaining variables
. rename _D events

. rename _Y pyr_10000

. rename _Rate rate_per_10000

. rename _Lower rate_cl

. rename _Upper rate_cu

. 
. /* Redaction  */ 
. 
. ** Remove event counts < 5, and complementary counts
. gen redact = inlist(events, 1, 2, 3, 4, 5)

. bysort wave outcome exposure expcat: egen redact_group = max(redact)

. replace events = -999 if redact_group==1 & !(exposure==6 & expcat==0 & redact
> ==0)
(0 real changes made)

. gen events_str = string(events)

. replace events_str = "<=5" if events_str=="-999"
(0 real changes made)

. order events_str, after(events)

. drop events redact redact_group

. rename events_str events

. 
. order wave outcome exposure category events pyr rate*

. sort wave outcome exposure expcat

. 
. 
. * Save data
. save "output/ldrates_wave`i'_`out'_mi", replace
(note: file output/ldrates_wave1_coviddeath_mi.dta not found)
file output/ldrates_wave1_coviddeath_mi.dta saved

. 
. 
. 
. ******************************
. *  Put output data together  *
. ******************************
. 
. use "output/ldrates_wave`i'_`out'_mi.dta", clear
(Analysis dataset, wave 1 (1 Mar - 31 Aug 20), for learning disability work)

. merge 1:1 outcome exposure expcat using ///
>         "output/ldhrs_wave`i'_`out'_mi.dta", assert(match) nogen
(note: variable expcat was byte, now float to accommodate using data's
       values)
(label outcome already defined)
(label exposure already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                 2  
    -----------------------------------------

. order wave outcome exposure expcat

. outsheet using "output/ldcox_wave`i'_`out'_mi.out", replace
(note: file output/ldcox_wave1_coviddeath_mi.out not found)

. erase "output/ldrates_wave`i'_`out'_mi.dta"

. erase "output/ldhrs_wave`i'_`out'_mi.dta"

. 
. log close
      name:  <unnamed>
       log:  /workspace/logs/AL011_cox_regression_wave2_covidadmission_MI.log
  log type:  text
 closed on:  23 Apr 2021, 12:02:18
-------------------------------------------------------------------------------
