-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /workspace/logs/AL003_cumulative_incidence.log
  log type:  text
 opened on:  11 Feb 2021, 11:44:14

. 
. 
. * Open data (complete case ethnicity for adults (16+))
. use "analysis/data_ldanalysis_cohort1", clear
(Analysis dataset, wave 1 (1 Mar - 31 Aug 20), for learning disability work)

. drop if ethnicity_5>=.
(250 observations deleted)

. keep if child==0
(157 observations deleted)

. 
. * Cycle over outcomes: mortality, composite (hospitalisation or mortality) 
. foreach out in coviddeath composite  {
  2. 
.         /*  Declare data to be survival  */
. 
.         stset stime_`out'2, fail(`out'2) 
  3.         
.         * Fit flexible survival model, adjusting for sex age and ethnicity
.         xi i.ethnicity_5 i.male 
  4.         stpm2 ldr age1 age2 age3 _I*, df(3) scale(hazard) eform 
  5. 
.         summ _t 
  6.         local tmax=r(max)
  7.         local tmaxplus1=r(max)+1
  8. 
.         range timevar 0 `tmax' `tmaxplus1'
  9.         stpm2_standsurv,                                                  
>       ///
>                 at1(ldr 0) at2(ldr 1) timevar(timevar)  ///
>                 ci contrast(difference) fail
 10. 
.         gen date = d(1/3/2020) + timevar 
 11.         format date %tddd_Month
 12. 
.         * Convert to % incidence scale
.         for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci: replace X=100*
> X
 13. 
.         * Print estimates
.         l date timevar _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if timev
> ar<.
 14. 
.         * Graph titles
.         local title_coviddeath = "Cumulative mortality (%)"
 15.         local label_coviddeath = "0(0.05)0.15"
 16. 
.         local title_composite = "Cumulative mortality or admission (%)"
 17.         local label_composite = "0(0.1)0.5"
 18.         
.         
.         * Graph
.         twoway  (rarea _at1_lci _at1_uci date, color(red%25))   ///
>                         (rarea _at2_lci _at2_uci date, color(blue%25))  ///
>                         (line _at1 date, sort lcolor(red))                   
>            ///
>                         (line _at2 date, sort lcolor(blue))                  
>    ///
>                         if agebroad==2,                                      
>                            ///
>                         legend(order(1 "Not on LDR" 2 "On LDR")              
>    ///
>                                 ring(0) cols(1) pos(11))                     
>                    ///
>                         ylabel(`label_`out'',angle(h) format(%4.2f))    ///
>                         ytitle("`title_`out''")                              
>                    ///
>                         xtitle("Date in 2020")
 19. 
.         
.         * Save graph
.         graph export "output/cumincidence_`out'.svg", as(svg) replace
 20.         
.         drop _at* _contrast* _I* _rcs* _d_rcs* timevar date
 21.         
. }

     failure event:  coviddeath2 != 0 & coviddeath2 < .
obs. time interval:  (0, stime_coviddeath2]
 exit on or before:  failure

------------------------------------------------------------------------------
        592  total observations
          0  exclusions
------------------------------------------------------------------------------
        592  observations remaining, representing
         19  failures in single-record/single-failure data
    176,471  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       330
i.ethnicity_5     _Iethnicity_1-5     (naturally coded; _Iethnicity_1 omitted)
i.male            _Imale_0-1          (naturally coded; _Imale_0 omitted)
command stpm2 is unrecognized
r(199);

end of do-file
r(199);
